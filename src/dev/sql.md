# SQL

## Виртуальная таблица

**Виртуальная таблица** - таблица со всеми [пакетами][1], которые пришли в [SQL узел][2] из определенного предыдущего узла.

Имя таблицы соответствует имени этого предыдущего узла.

Столбцами таблицы являются переменные [пакета][1], выходящего из предыдущего узла.

Если в [SQL узел][2] входят пакеты из разных узлов, то для каждого из них будет собственная виртуальная таблица.

## Запрос SQL узла

[SQL узел][2] должен содержать SQL запрос выбора данных. Общие правила создания запроса должны соответствовать требованиям использования SQL команды ([SELECT](https://www.postgresql.org/docs/13/sql-select.html)) на диалекте СУБД [PostgreSQL](https://www.postgresql.org).

Выбор данных производится из [виртуальных таблиц](#виртуальная-таблица).

::: tip <span class="iconify" data-icon="mdi:information" style="color: #42b983; font-size: 24px;"></span>
Используйте [SQL мастер](#sql-мастер) для создания запроса.
:::

Пример:

![SQL example](/images/common/sql_example.png)

Объединение двух пакетов по одинаковому полю.

```sql:no-line-numbers
select
    array[c.id, s.id] as packages,
    s.size,
    s.span,
    s.x,
    s.sin,
    c.cos
from sin s join cos c on s.job_id = c.job_id
```

Здесь:

- `array[c.id, s.id] as packages` - обязательное поле с идентификаторами родительских пакетов;
- `sin` и `сos` - имена виртуальных таблиц, которые соответствуют именам узлов, соединенные с входом SQL-узла;
- `job_id` - произвольный идентификатор, присвоенный в узле **generate**;
- `s.*` и `c.cos`-переменные соответствующих пакетов.

Tip warning
::: warning <span class="iconify" data-icon="emojione-v1:warning" style="color: #e7c000; font-size: 24px;"></span>

При создании запроса в качестве условных параметров можно использовать только [переменные пакета][1] типа "поле". В качестве возвращаемых переменных можно использовать любые переменные пакета.
:::

## SQL мастер

**SQL мастер** - используется для быстрого построения шаблона для [SQL запроса](#запрос-sql-узла).

Для вызова SQL мастера необходимо нажать на иконку <span class="iconify-inline" data-icon="mdi:auto-fix"></span> на [панели SQL узла](/docs/desc/nodes.md#запрос)

![SQL Master](/images/common/sql_wizard.png)

Структура:

- Панели [виртуальных таблиц](#виртуальная-таблица)

  - Название таблицы
  - Описание таблицы
  - <span class="iconify-inline" data-icon="mdi:checkbox-marked" style="color: green"></span> Переключатель добавления таблицы в запрос
  - <span class="iconify-inline" data-icon="mdi:menu-down"></span> Выпадающее меню столбцов таблицы

    - Тип столбца
    - Имя и описание
    - <span class="iconify-inline" data-icon="mdi:checkbox-marked" style="color: green"></span> Переключатель добавления столбца в запрос

    ![SQL Master](/images/common/sql_wizard_table_variables.png)

- Результат - тип выходного [пакета][1]
  - Плоский пакет - обычный [пакет][1]
  - Вложенные пакеты - [пакет][1], в которой добавлен переменная типа "массив пакетов".
- <span class="iconify-inline" data-icon="mdi:checkbox-marked" style="color: green"></span> Псевдонимы столбцов - переключатель добавления псевдонимов столбцов в запросе
- <span class="iconify-inline" data-icon="mdi:checkbox-marked" style="color: green"></span> Имена таблиц в псевдонимах - использовать имена виртуальных таблиц при формировании псевдонимов столбцов в запросе
- Кнопка "ПОСТРОИТЬ ЗАПРОС" - перегенерировать запрос
- Редактор сгенерированного запроса
- Кнопка "ЗАМЕНИТЬ" - заменить существующий запрос узла новым запросом
- Кнопка "ДОБАВИТЬ" - добавить запрос к существующему запросу узла
- Кнопка "ОТМЕНА" - выйти из мастера

[1]: /docs/desc/nodes.md#пакеты
[2]: /docs/desc/nodes.md#sql-узел
